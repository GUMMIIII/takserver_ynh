#!/bin/bash

set -e

# YunoHost helper laden
source /usr/share/yunohost/helpers

# Variablen aus YunoHost App-Argumenten
domain=${YNH_APP_ARG_DOMAIN}
deb_path=${YNH_APP_ARG_DEB_PATH}
country=${YNH_APP_ARG_COUNTRY}
state=${YNH_APP_ARG_STATE}
city=${YNH_APP_ARG_CITY}
org=${YNH_APP_ARG_ORG}
orgunit=${YNH_APP_ARG_ORGANIZATIONAL_UNIT}
ca_name=${YNH_APP_ARG_CA_NAME}
signing_ca_name=${YNH_APP_ARG_SIGNING_CA_NAME}
install_dir="/opt/tak"

ynh_print_info "Installiere Abhängigkeiten (Java, PostgreSQL, LDAP tools, etc.)..."
apt-get update
apt-get install -y openjdk-17-jre postgresql postgresql-client ldap-utils

ynh_print_info "Setze Datei-Limits für Java..."
grep -q 32768 /etc/security/limits.conf || echo '* soft nofile 32768' >> /etc/security/limits.conf

ynh_print_info "Installiere TAK Server .deb..."
dpkg -i "$deb_path"

# Zugriffsrechte sicherstellen
chown -R tak:tak /opt/tak/certs/
chmod -R u+rwX /opt/tak/certs/

# PKI Umgebung initialisieren
ynh_print_info "Initialisiere PKI Umgebung und Zertifikate..."

su - tak -c "
  export COUNTRY='$country'
  export STATE='$state'
  export CITY='$city'
  export ORGANIZATIONAL_UNIT='$orgunit'
  export ORGANIZATION='$org'
  export CAPASS='atakatak'
  export PASS='atakatak'
  cd $install_dir/certs

  # Alle Metadaten korrekt setzen
  sed -i 's/^COUNTRY=.*/COUNTRY=\"$country\"/' cert-metadata.sh
  sed -i 's/^STATE=.*/STATE=\"$state\"/' cert-metadata.sh
  sed -i 's/^CITY=.*/CITY=\"$city\"/' cert-metadata.sh
  sed -i 's/^ORGANIZATIONAL_UNIT=.*/ORGANIZATIONAL_UNIT=\"$orgunit\"/' cert-metadata.sh
  sed -i 's/^ORGANIZATION=.*/ORGANIZATION=\"$org\"/' cert-metadata.sh

  # Root CA, Signing CA, Server-Zertifikat, Admin-Zertifikat erzeugen
  ./makeRootCa.sh --ca-name \"$ca_name\"
  ./makeCert.sh ca \"$signing_ca_name\"
  ./makeCert.sh server takserver
  ./makeCert.sh client webadmin
"

# CoreConfig vorbereiten und anpassen
coreconfig_file="$install_dir/CoreConfig.xml"
exampleconfig="$install_dir/CoreConfig.example.xml"
if [ ! -f "$coreconfig_file" ] && [ -f "$exampleconfig" ]; then
    cp "$exampleconfig" "$coreconfig_file"
fi

# CoreConfig auf aktuelle CA und Truststore umstellen
sed -i "s/truststore-root/truststore-${signing_ca_name}/g" "$coreconfig_file"

# Nginx Reverse Proxy einrichten
ynh_print_info "Richte Nginx Reverse Proxy ein..."
nginx_conf="/etc/nginx/conf.d/${domain}.conf"

mkdir -p "/etc/nginx/conf.d/${domain}.d"
cat > "/etc/nginx/conf.d/${domain}.d/takserver.conf" <<EOL
location / {
    proxy_pass https://localhost:8443/;
    proxy_set_header Host \$host;
    proxy_set_header X-Real-IP \$remote_addr;
    proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto \$scheme;
    proxy_ssl_verify off;
    proxy_http_version 1.1;
    proxy_set_header Upgrade \$http_upgrade;
    proxy_set_header Connection "upgrade";
}
EOL

tak_include="include /etc/nginx/conf.d/${domain}.d/*.conf;"
if ! grep -qF "$tak_include" "$nginx_conf"; then
    awk -v inc="$tak_include" '
        /server_name/ { print; getline; print; print inc; next }
        { print }
    ' "$nginx_conf" > "${nginx_conf}.patched" && mv "${nginx_conf}.patched" "$nginx_conf"
fi

nginx -t && systemctl reload nginx

# TAK-Server-Service aktivieren und starten
ynh_print_info "Aktiviere und starte TAK Service..."
systemctl enable takserver.service
systemctl restart takserver.service

ynh_print_info "TAK Server erfolgreich installiert! WebUI: https://${domain}/"
